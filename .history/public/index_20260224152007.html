<!DOCTYPE html>
<html lang="th">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>AI Tasseography Reader</title>
  <style>
    body {
      margin: 0;
      overflow: hidden;
      background: #1a1a1a;
      color: #d4af37;
      font-family: 'Courier New', serif;
    }

    canvas {
      display: block;
      position: absolute;
      top: 0;
      left: 0;
      z-index: 1;
    }

    #ui-layer {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 10;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      text-align: center;
      pointer-events: none;
      background: rgba(0, 0, 0, 0.6);
      transition: opacity 0.5s;
    }

    h1 {
      font-size: 2rem;
      margin-bottom: 10px;
      text-transform: uppercase;
      letter-spacing: 3px;
    }

    p {
      font-size: 1.2rem;
      max-width: 80%;
      line-height: 1.6;
    }

    .btn {
      pointer-events: auto;
      margin-top: 20px;
      padding: 15px 40px;
      font-size: 1.2rem;
      background: transparent;
      color: #d4af37;
      border: 2px solid #d4af37;
      border-radius: 50px;
      cursor: pointer;
      text-transform: uppercase;
      letter-spacing: 2px;
      transition: all 0.3s;
    }

    .btn:active {
      background: #d4af37;
      color: #000;
    }

    #loading {
      display: none;
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 20;
      color: white;
    }

    /* ผลลัพธ์ */
    #result-modal {
      display: none;
      position: absolute;
      top: 10%;
      left: 5%;
      width: 90%;
      height: 80%;
      background: #111;
      border: 1px solid #d4af37;
      z-index: 30;
      padding: 20px;
      box-sizing: border-box;
      overflow-y: auto;
      text-align: left;
    }

    .close-btn {
      float: right;
      cursor: pointer;
      font-size: 1.5rem;
    }
  </style>
</head>

<body>

  <div id="ui-layer">
    <h1 id="status-title">Tasseography</h1>
    <p id="instruction">ตั้งจิตอธิษฐาน แล้วกดเริ่มพิธีกรรม</p>
    <button id="action-btn" class="btn">Start Ritual</button>
  </div>

  <canvas id="teaCanvas"></canvas>

  <div id="loading">กำลังสื่อสารกับดวงดาว...</div>

  <div id="result-modal">
    <span class="close-btn" onclick="location.reload()">×</span>
    <h2 style="text-align:center; color:#d4af37">คำทำนายของคุณ</h2>
    <div id="ai-response-text" style="color: #ccc; white-space: pre-wrap;"></div>
  </div>

  <script>
    // --- PART 1: SETUP & PHYSICS ---
    const canvas = document.getElementById('teaCanvas');
    const ctx = canvas.getContext('2d');
    const ui = document.getElementById('ui-layer');
    const title = document.getElementById('status-title');
    const instruct = document.getElementById('instruction');
    const btn = document.getElementById('action-btn');

    let width, height;
    let particles = [];
    let state = 'IDLE'; // IDLE, DRINK, SHAKE, SETTLE, REVEAL
    let gyroscope = { x: 0, y: 0 };

    // ตั้งค่า Canvas
    function resize() {
      width = window.innerWidth;
      height = window.innerHeight;
      canvas.width = width;
      canvas.height = height;
    }
    window.addEventListener('resize', resize);
    resize();

    // ก้อนใบชา (Particle Class)
    class Particle {
      constructor() {
        this.x = Math.random() * width;
        this.y = Math.random() * height;
        this.size = Math.random() * 3 + 1.5; // ขนาดใบ
        this.vx = 0; this.vy = 0;
        this.friction = 0.92;
        // สีใบชา (ดำอมน้ำตาล)
        this.color = `rgba(${30 + Math.random() * 20}, ${15 + Math.random() * 10}, 0, ${0.7 + Math.random() * 0.3})`;
      }

      update() {
        if (state === 'REVEAL') return; // หยุดนิ่งเมื่อแสดงผล

        // 1. รับแรงจาก Gyroscope
        if (state === 'SHAKE') {
          this.vx += gyroscope.x * 0.8;
          this.vy += gyroscope.y * 0.8;
        } else if (state === 'DRINK') {
          // ไหลลงตามแรงโน้มถ่วง
          this.vy += 2;
        }

        // 2. Clustering Logic (สำคัญมาก! ช่วยให้เกิดรูปทรง)
        // เมื่อเริ่มตกตะกอน ให้ดูดเข้าหาเพื่อนบ้านใกล้ๆ
        if (state === 'SETTLE') {
          this.vx *= 0.5; // หนืดมาก
          this.vy *= 0.5;

          // ค้นหาเพื่อนบ้าน (Simplified loop)
          // ใน production ควรใช้ Quadtree เพื่อ performance
          // นี่คือ Hack ง่ายๆ: ดึงเข้าหากลางจอเล็กน้อย + Random Noise
          const dx = (width / 2) - this.x;
          const dy = (height / 2) - this.y;
          this.vx += dx * 0.001;
          this.vy += dy * 0.001;
        }

        // Physics
        this.vx *= this.friction;
        this.vy *= this.friction;
        this.x += this.vx;
        this.y += this.vy;

        // ขอบเขต (Bounce)
        if (this.x < 0 || this.x > width) this.vx *= -1;
        if (this.y < 0 || this.y > height) this.vy *= -1;
      }

      draw() {
        ctx.beginPath();
        ctx.fillStyle = this.color;
        // วาดใบชาบิดเบี้ยวเล็กน้อย
        ctx.ellipse(this.x, this.y, this.size, this.size * 0.7, Math.random() * Math.PI, 0, Math.PI * 2);
        ctx.fill();
      }
    }

    function initParticles() {
      particles = [];
      // สร้างใบชา 800 ใบ
      for (let i = 0; i < 800; i++) particles.push(new Particle());
    }

    function animate() {
      // Clear จอแบบมีความจาง (Trail Effect) เฉพาะตอนเขย่า
      ctx.fillStyle = state === 'SHAKE' ? 'rgba(230, 220, 200, 0.4)' : 'rgba(230, 220, 200, 1)';
      ctx.fillRect(0, 0, width, height);

      // วาดขอบถ้วย
      ctx.strokeStyle = '#d4af37';
      ctx.lineWidth = 15;
      ctx.beginPath();
      ctx.arc(width / 2, height / 2, Math.min(width, height) * 0.4, 0, Math.PI * 2);
      ctx.stroke();

      // Clip ให้ใบชาอยู่ในถ้วย (Visual Only)
      ctx.save();
      ctx.beginPath();
      ctx.arc(width / 2, height / 2, Math.min(width, height) * 0.4, 0, Math.PI * 2);
      ctx.clip();

      particles.forEach(p => { p.update(); p.draw(); });
      ctx.restore();

      requestAnimationFrame(animate);
    }

    // --- PART 2: CONTROL FLOW ---

    btn.addEventListener('click', async () => {
      if (state === 'IDLE') {
        // ขอ Permission iOS
        if (typeof DeviceMotionEvent.requestPermission === 'function') {
          await DeviceMotionEvent.requestPermission();
        }
        startRitual();
      } else if (state === 'SETTLE') {
        revealFuture();
      }
    });

    function startRitual() {
      initParticles();
      animate();
      state = 'SHAKE';
      title.innerText = "SHAKE IT";
      instruct.innerText = "เขย่ามือถือเพื่อให้ใบชากระจายตัว... เขย่าแรงๆ!";
      btn.style.display = 'none';

      // จับ Sensor
      window.addEventListener('devicemotion', (e) => {
        if (state !== 'SHAKE') return;
        const acc = e.accelerationIncludingGravity;
        if (acc) {
          gyroscope.x = acc.x || 0;
          gyroscope.y = acc.y || 0;
        }
      });

      // 5 วินาทีต่อมา ให้หยุดเขย่า
      setTimeout(() => {
        state = 'SETTLE';
        title.innerText = "WAITING...";
        instruct.innerText = "ใบชากำลังก่อตัว... รอสักครู่";

        // รอให้ตกตะกอน 3 วินาที
        setTimeout(() => {
          btn.innerText = "Reveal Destiny";
          btn.style.display = 'block';
          instruct.innerText = "ก้นแก้วพร้อมแล้ว กดปุ่มเพื่อเปิดคำทำนาย";
        }, 3000);

      }, 5000);
    }

    function revealFuture() {
      state = 'REVEAL';
      ui.style.opacity = '0'; // ซ่อน UI ให้เห็นถ้วยชัดๆ

      setTimeout(() => {
        // จับภาพหน้าจอส่งไป AI
        captureAndAnalyze();
      }, 1000);
    }

    // --- PART 3: AI INTEGRATION (Vision API) ---

    async function captureAndAnalyze() {
      document.getElementById('loading').style.display = 'block';

      // 1. แปลง Canvas เป็นรูปภาพ (JPEG)
      const imageData = canvas.toDataURL('image/jpeg', 0.7);
      const base64Image = imageData.split(',')[1]; // ตัด header ออก

      // 2. Prompt สำหรับ AI
      const promptText = `
        You are a mystical Tasseography (Tea Leaf Reading) expert. 
        Analyze the chaotic tea leaf patterns in this image inside the cup circle.
        
        1. Identify 1 distinct shape that the clumps of tea leaves resemble (e.g., an animal, object, or nature symbol). Use your imagination (pareidolia).
        2. Reference traditional meanings like those found on tasseography.com.
        3. Provide a short, mystical fortune based on that symbol.
        
        Format the output in Thai language as:
        - **สัญลักษณ์ที่พบ:** [ชื่อสัญลักษณ์]
        - **ความหมาย:** [ความหมายสั้นๆ]
        - **คำทำนาย:** [คำทำนาย 2-3 ประโยค]
        `;

      // 3. เรียก API (ตัวอย่างใช้ Google Gemini API Concept)
      // ** คำเตือน: ในการใช้งานจริง อย่าใส่ API Key ใน Frontend **
      // ให้ส่ง imageData ไปที่ Backend ของคุณแทน

      const API_KEY = "YOUR_GEMINI_API_KEY_HERE"; // <--- ใส่ Key ที่นี่เพื่อเทส
      const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${API_KEY}`;

      try {
        const response = await fetch(API_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            contents: [{
              parts: [
                { text: promptText },
                { inline_data: { mime_type: "image/jpeg", data: base64Image } }
              ]
            }]
          })
        });

        const data = await response.json();

        // ดึงข้อความตอบกลับ
        const aiText = data.candidates[0].content.parts[0].text;

        // แสดงผล
        document.getElementById('loading').style.display = 'none';
        document.getElementById('result-modal').style.display = 'block';
        document.getElementById('ai-response-text').innerText = aiText;

      } catch (error) {
        console.error(error);
        document.getElementById('loading').style.display = 'none';
        alert("The spirits are silent (API Error). Check console.");
      }
    }
  </script>
</body>

</html>