<!DOCTYPE html>
<html lang="th">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Real Tasseography (Redesigned)</title>
  <style>
    body {
      margin: 0;
      overflow: hidden;
      /* พื้นหลังข้างนอกถ้วย: ไล่สีเข้มดูลึกลับ */
      background: radial-gradient(circle at center, #2e1e3b 0%, #0a0510 100%);
      color: #d4af37;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    canvas {
      display: block;
      /* เพิ่มเงาให้ตัวถ้วยดูลอยออกมา */
      filter: drop-shadow(0 0 20px rgba(212, 175, 55, 0.3));
    }

    #ui {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      pointer-events: none;
      text-align: center;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.8);
    }

    h1 {
      letter-spacing: 3px;
      margin-bottom: 10px;
    }

    p.sub-text {
      font-size: 1.1rem;
      color: #e0d0a8;
      margin-bottom: 30px;
    }

    button {
      pointer-events: auto;
      padding: 18px 40px;
      font-size: 1.2rem;
      background: linear-gradient(45deg, #d4af37, #f9d976);
      border: none;
      border-radius: 50px;
      color: #2e1e3b;
      font-weight: bold;
      cursor: pointer;
      box-shadow: 0 4px 15px rgba(212, 175, 55, 0.4);
      transition: transform 0.2s;
    }

    button:active {
      transform: scale(0.95);
    }

    #prediction-box {
      display: none;
      position: absolute;
      bottom: 0;
      left: 0;
      width: 100%;
      background: rgba(15, 10, 20, 0.95);
      padding: 25px;
      box-sizing: border-box;
      border-top: 3px solid #d4af37;
      min-height: 30vh;
      box-shadow: 0 -5px 20px rgba(0, 0, 0, 0.5);
    }
  </style>
</head>

<body>

  <canvas id="canvas"></canvas>

  <div id="ui">
    <h1 id="status-text">TASSEOGRAPHY</h1>
    <p id="instruction-text" class="sub-text">ตั้งจิตอธิษฐาน แล้วเริ่มพิธีกรรม</p>
    <button id="btn">Start Ritual</button>
  </div>

  <div id="prediction-box">
    <h3 style="margin-top:0; color:#f9d976;">คำทำนายจากก้นแก้ว</h3>
    <p id="result-text" style="color: #e0d0a8; line-height: 1.6;">กำลังเชื่อมต่อกับจักรวาล...</p>
    <button onclick="location.reload()" style="margin-top:15px; padding: 10px 25px; font-size: 1rem;">เล่นใหม่</button>
  </div>

  <script>
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const uiStatus = document.getElementById('status-text');
    const uiSubText = document.getElementById('instruction-text');
    const btn = document.getElementById('btn');

    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;

    // --- PHYSICS VARIABLES ---
    let particles = [];
    const NUM_PARTICLES = 700; // เพิ่มจำนวนใบชาให้ดูเข้มข้นขึ้น
    const CUP_RADIUS = Math.min(canvas.width, canvas.height) * 0.42;
    const CENTER_X = canvas.width / 2;
    const CENTER_Y = canvas.height / 2;

    let accX = 0, accY = 0;
    let tiltX = 0, tiltY = 0;
    let state = 'IDLE';

    class TeaLeaf {
      constructor() {
        const angle = Math.random() * Math.PI * 2;
        const r = Math.sqrt(Math.random()) * CUP_RADIUS;
        this.x = CENTER_X + r * Math.cos(angle);
        this.y = CENTER_Y + r * Math.sin(angle);

        this.vx = 0; this.vy = 0;
        this.mass = 1 + Math.random() * 3;
        this.friction = 0.94;

        this.size = this.mass * 1.8;
        this.rotation = Math.random() * Math.PI;

        // --- สีใบชา (ปรับใหม่) ---
        // ให้เป็นสีน้ำตาลเข้มจัดๆ เกือบดำ เพื่อตัดกับพื้นหลังสีครีม
        const darkness = Math.random() * 30;
        // สีโทน Sepia เข้มๆ
        this.color = `rgba(${40 - darkness}, ${25 - darkness * 0.5}, 5, 0.95)`;
      }

      update() {
        if (state === 'REVEAL') return;
        this.vx -= (accX * 0.8) / this.mass;
        this.vy -= (accY * 0.8) / this.mass;
        this.vx += tiltX * 0.05;
        this.vy += tiltY * 0.05;
        this.vx *= this.friction;
        this.vy *= this.friction;
        this.x += this.vx;
        this.y += this.vy;

        const dx = this.x - CENTER_X;
        const dy = this.y - CENTER_Y;
        const dist = Math.sqrt(dx * dx + dy * dy);

        if (dist > CUP_RADIUS) {
          const angle = Math.atan2(dy, dx);
          this.x = CENTER_X + Math.cos(angle) * CUP_RADIUS;
          this.y = CENTER_Y + Math.sin(angle) * CUP_RADIUS;
          this.vx *= -0.4;
          this.vy *= -0.4;
        }
      }

      draw() {
        ctx.save();
        ctx.translate(this.x, this.y);
        ctx.rotate(this.rotation);
        ctx.fillStyle = this.color;
        ctx.beginPath();
        // วาดใบรูปร่างซับซ้อนขึ้นนิดหน่อย
        ctx.moveTo(0, -this.size / 2);
        ctx.quadraticCurveTo(this.size / 2, 0, 0, this.size / 2);
        ctx.quadraticCurveTo(-this.size / 2, 0, 0, -this.size / 2);
        ctx.fill();
        ctx.restore();
      }
    }

    // --- MAIN DRAW LOOP (ส่วนที่แก้ไขเยอะที่สุด) ---
    function loop() {
      // 1. ล้างหน้าจอ (พื้นที่รอบนอกถ้วย)
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      // 2. วาด "ก้นถ้วย" (พื้นที่สีครีม)
      ctx.save(); // บันทึกสถานะก่อน Clip
      ctx.beginPath();
      ctx.arc(CENTER_X, CENTER_Y, CUP_RADIUS, 0, Math.PI * 2);

      // สร้าง Gradient ให้ก้นถ้วยดูมีมิติ (ครีมสว่าง -> ครีมเข้ม)
      let cupGradient = ctx.createRadialGradient(CENTER_X, CENTER_Y, CUP_RADIUS * 0.2, CENTER_X, CENTER_Y, CUP_RADIUS);
      cupGradient.addColorStop(0, '#fffbf0'); // ตรงกลางสว่าง (Off-white)
      cupGradient.addColorStop(1, '#e0d0a8'); // ขอบๆ สีเข้มขึ้น (Antique cream)
      ctx.fillStyle = cupGradient;
      ctx.fill();

      // 3. Clip พื้นที่ (สำคัญ! เพื่อไม่ให้ใบชาหลุดออกนอกก้นแก้ว)
      ctx.clip();

      // 4. วาดใบชา (สีเข้ม) ลงบนพื้นหลังสีครีม
      particles.forEach(p => {
        p.update();
        p.draw();
      });

      ctx.restore(); // ยกเลิก Clip

      // 5. วาดขอบถ้วยสีทองทับด้านบนสุด
      ctx.strokeStyle = '#d4af37';
      ctx.lineWidth = 12;
      ctx.beginPath();
      ctx.arc(CENTER_X, CENTER_Y, CUP_RADIUS, 0, Math.PI * 2);
      ctx.stroke();
      // เพิ่มขอบเงาด้านในเล็กน้อย
      ctx.strokeStyle = 'rgba(0,0,0,0.2)';
      ctx.lineWidth = 2;
      ctx.beginPath();
      ctx.arc(CENTER_X, CENTER_Y, CUP_RADIUS - 6, 0, Math.PI * 2);
      ctx.stroke();

      requestAnimationFrame(loop);
    }

    // --- LOGIC เดิม ---
    function init() {
      particles = [];
      for (let i = 0; i < NUM_PARTICLES; i++) particles.push(new TeaLeaf());
      loop();
    }

    function handleMotion(event) {
      const acc = event.acceleration || event.accelerationIncludingGravity;
      if (acc) { accX = acc.x || 0; accY = acc.y || 0; }
    }

    function handleOrientation(event) {
      tiltX = event.gamma || 0; tiltY = event.beta || 0;
    }

    btn.addEventListener('click', async () => {
      if (typeof DeviceMotionEvent.requestPermission === 'function') {
        const response = await DeviceMotionEvent.requestPermission();
        if (response !== 'granted') return alert('ต้องการสิทธิ์เข้าถึง Sensor');
      }
      window.addEventListener('devicemotion', handleMotion);
      window.addEventListener('deviceorientation', handleOrientation);

      state = 'BREWING';
      uiStatus.innerText = "SHAKE THE CUP!";
      uiSubText.innerText = "เขย่ามือถือให้ทั่ว เพื่อกระจายใบชา";
      btn.style.display = 'none';

      setTimeout(reveal, 6000);
      init();
    });

    async function reveal() {
      state = 'REVEAL';
      document.getElementById('ui').style.display = 'none';
      window.removeEventListener('devicemotion', handleMotion);
      document.getElementById('prediction-box').style.display = 'block';

      // จับภาพเฉพาะส่วน Canvas ที่วาดไปส่งให้ AI
      const dataURL = canvas.toDataURL('image/jpeg', 0.8);
      const base64 = dataURL.split(',')[1];

      try {
        // แก้ Path ให้เรียกไปที่ /api/predict (เผื่อกรณี Vercel)
        const res = await fetch('/api/predict', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ imageBase64: base64 })
        });
        const data = await res.json();
        if (data.success) {
          document.getElementById('result-text').innerText = data.prediction;
        } else {
          document.getElementById('result-text').innerText = "มองไม่ชัด... ลองใหม่อีกครั้ง";
        }
      } catch (e) {
        document.getElementById('result-text').innerText = "Error Connecting to Spirit World.";
      }
    }
  </script>
</body>

</html>